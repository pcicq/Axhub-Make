<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>{{TITLE}}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,
    body {
       box-sizing: border-box;
      width: 100%;
      margin: 0;
      padding: 0;
      height: auto;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #root {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      /* min-height: 100vh; */
      overflow: visible;
    }

    /* 如果是元素演示页面（可能被内嵌到 iframe），设置固定尺寸 */
    body.is-element-page #root {
      width: 100vw;
      height: 100vh;
    }

    /* 平板和手机模式隐藏滚动条 */
    @media (max-width: 1024px) {
      ::-webkit-scrollbar {
        display: none;
      }

      html,
      body {
        scrollbar-width: none;
        /* Firefox */
      }
    }
  </style>
</head>

<body>

  <script>
    // 全局错误捕获系统（增强版）
    (function () {
      // 等待 DevTemplateBootstrap 加载后检查 inspecta 模式
      // 如果是 inspecta 模式则禁用错误捕获
      function checkInspectaMode() {
        if (window.DevTemplateBootstrap && window.DevTemplateBootstrap.inspectaMode) {
          console.log('%c[Error System] Inspecta 模式已启用，错误捕获已禁用', 'color: #faad14; font-weight: bold;');
          return true;
        }
        return false;
      }
      
      // 先快速检查 URL 参数（避免在 bootstrap 加载前就触发错误）
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('inspecta') === 'true') {
        console.log('%c[Error System] 检测到 inspecta 参数，错误捕获已禁用', 'color: #faad14; font-weight: bold;');
        return;
      }

      const bootTime = Date.now();
      const errorQueue = [];
      let reactReady = false;
      let fallbackUIShown = false;

      // 保存原始的 console 方法
      const originalConsoleError = console.error;
      const originalConsoleWarn = console.warn;

      // 简易版错误显示（降级方案）
      function showFallbackErrorUI(errors) {
        if (fallbackUIShown) {
          // 更新已有的错误列表
          const errorList = document.getElementById('__fallback_error_list__');
          if (errorList) {
            errorList.innerHTML = errors.map((err, idx) => 
              '<div style="margin-bottom: 12px; padding: 8px; background: #fff1f0; border-left: 3px solid #ff4d4f; border-radius: 2px;">' +
              '<div style="font-weight: 600; color: #cf1322; margin-bottom: 4px;">[' + (idx + 1) + '] ' + escapeHtml(err.message) + '</div>' +
              (err.stack ? '<pre style="margin: 0; font-size: 11px; color: #666; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">' + escapeHtml(err.stack) + '</pre>' : '') +
              '</div>'
            ).join('');
          }
          return;
        }

        fallbackUIShown = true;
        const overlay = document.createElement('div');
        overlay.id = '__fallback_error_overlay__';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 999999; display: flex; align-items: flex-start; justify-content: center; padding: 40px 20px; overflow: auto;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 700px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;';
        
        modal.innerHTML = 
          '<div style="padding: 16px 24px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between;">' +
          '<div style="display: flex; align-items: center; gap: 8px;">' +
          '<svg viewBox="64 64 896 896" width="20" height="20" fill="#ff4d4f"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm-32 232c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v272c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V296zm32 440a48.01 48.01 0 0 1 0-96 48.01 48.01 0 0 1 0 96z"></path></svg>' +
          '<span style="font-size: 16px; font-weight: 600; color: #262626;">运行时错误 (' + errors.length + ')</span>' +
          '</div>' +
          '<button id="__fallback_close__" style="border: none; background: none; cursor: pointer; font-size: 20px; color: #8c8c8c; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>' +
          '</div>' +
          '<div id="__fallback_error_list__" style="padding: 24px; overflow-y: auto; flex: 1;">' +
          errors.map((err, idx) => 
            '<div style="margin-bottom: 12px; padding: 8px; background: #fff1f0; border-left: 3px solid #ff4d4f; border-radius: 2px;">' +
            '<div style="font-weight: 600; color: #cf1322; margin-bottom: 4px;">[' + (idx + 1) + '] ' + escapeHtml(err.message) + '</div>' +
            (err.stack ? '<pre style="margin: 0; font-size: 11px; color: #666; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">' + escapeHtml(err.stack) + '</pre>' : '') +
            '</div>'
          ).join('') +
          '</div>' +
          '<div style="padding: 12px 24px; border-top: 1px solid #f0f0f0; display: flex; gap: 8px; justify-content: flex-end;">' +
          '<button id="__fallback_copy__" style="padding: 6px 16px; border: 1px solid #d9d9d9; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">复制错误</button>' +
          '<button id="__fallback_clear__" style="padding: 6px 16px; border: 1px solid #d9d9d9; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">清空并关闭</button>' +
          '</div>';
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // 绑定事件
        document.getElementById('__fallback_close__').onclick = function() {
          overlay.style.display = 'none';
        };
        
        document.getElementById('__fallback_clear__').onclick = function() {
          errorQueue.length = 0;
          document.body.removeChild(overlay);
          fallbackUIShown = false;
        };
        
        document.getElementById('__fallback_copy__').onclick = function() {
          const text = errors.map((err, idx) => 
            '[' + (idx + 1) + '] ' + err.message + '\n' + (err.stack || '无堆栈信息')
          ).join('\n\n' + '='.repeat(80) + '\n\n');
          
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
              alert('错误信息已复制到剪贴板');
            }).catch(function() {
              prompt('请手动复制以下内容:', text);
            });
          } else {
            prompt('请手动复制以下内容:', text);
          }
        };
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 统一的错误处理函数
      function handleError(message, stack, type) {
        const error = {
          message: message,
          stack: stack,
          timestamp: Date.now(),
          sinceBoot: Date.now() - bootTime,
          type: type
        };

        errorQueue.push(error);

        // 如果 React 已就绪，使用 React 组件显示
        if (reactReady && typeof window.showErrorDialog === 'function') {
          window.showErrorDialog(message, stack);
        } else {
          // 否则使用降级 UI
          showFallbackErrorUI(errorQueue);
        }
      }

      // 捕获未处理的错误（捕获阶段，优先级最高）
      window.addEventListener('error', function (event) {
        originalConsoleError.call(console, '捕获到错误事件:', {
          message: event.message,
          error: event.error,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno
        });

        try {
          let message = event.message || '发生了一个未知错误';
          let stack = '';

          if (event.error && event.error.stack) {
            stack = event.error.stack;
          } else if (event.error && event.error.message) {
            message = event.error.message;
            stack = '无详细堆栈信息';
          } else if (event.filename) {
            stack = event.filename + ':' + event.lineno + ':' + event.colno;
          } else {
            stack = '无堆栈信息';
          }

          handleError(message, stack, 'error');
        } catch (err) {
          originalConsoleError.call(console, '[Error Handler] 处理错误失败:', err);
        }

        event.preventDefault();
      }, true); // ⚠️ 使用捕获阶段

      // 捕获未处理的 Promise 拒绝
      window.addEventListener('unhandledrejection', function (event) {
        originalConsoleError.call(console, '捕获到未处理的 Promise 拒绝:', event.reason);

        try {
          const message = event.reason && event.reason.message
            ? event.reason.message
            : String(event.reason || '未知 Promise 拒绝');
          const stack = event.reason && event.reason.stack ? event.reason.stack : '';

          handleError('Promise 拒绝: ' + message, stack, 'unhandledrejection');
        } catch (err) {
          originalConsoleError.call(console, '[Error Handler] 处理 Promise 拒绝失败:', err);
        }

        event.preventDefault();
      });

      // 拦截 console.error（可选，捕获库的错误输出）
      console.error = function () {
        const args = Array.prototype.slice.call(arguments);
        const message = args.join(' ');

        // 先调用原始的 console.error
        originalConsoleError.apply(console, args);

        // 检查是否是重要错误
        const lowerMessage = message.toLowerCase();
        const shouldShow = !message.includes('[Error Dialog]') && 
                          !message.includes('[Error Handler]') &&
                          (lowerMessage.includes('error') || lowerMessage.includes('failed'));
        
        if (shouldShow) {
          try {
            const stack = new Error().stack || '无堆栈信息';
            handleError('控制台错误: ' + message, stack, 'console.error');
          } catch (err) {
            originalConsoleError.call(console, '[Error Handler] 显示对话框失败:', err);
          }
        }
      };

      // 暴露 React 就绪标记
      window.__ERROR_SYSTEM__ = {
        markReactReady: function() {
          reactReady = true;
          console.log('%c[Error System] React 错误系统已就绪', 'color: #52c41a; font-weight: bold;');
          
          // 如果有降级 UI 显示，迁移到 React 组件
          if (fallbackUIShown && errorQueue.length > 0 && typeof window.showErrorDialog === 'function') {
            const overlay = document.getElementById('__fallback_error_overlay__');
            if (overlay) {
              overlay.style.display = 'none';
            }
            errorQueue.forEach(function(err) {
              window.showErrorDialog(err.message, err.stack);
            });
          }
        },
        getErrorQueue: function() {
          return errorQueue;
        },
        clearErrors: function() {
          errorQueue.length = 0;
          const overlay = document.getElementById('__fallback_error_overlay__');
          if (overlay && overlay.parentNode) {
            document.body.removeChild(overlay);
            fallbackUIShown = false;
          }
        }
      };

      console.log('%c[Error System] 全局错误捕获已启用（增强版）', 'color: #52c41a; font-weight: bold;');
    })();
  </script>

  <script>
    // 判断是否为元素演示页面（在 body 加载后执行）
    (function () {
      if (document.body && window.location.pathname.includes('/elements/')) {
        document.body.classList.add('is-element-page');
      } else if (!document.body) {
        // 如果 body 还没加载，等待 DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function () {
          if (window.location.pathname.includes('/elements/')) {
            document.body.classList.add('is-element-page');
          }
        });
      }
    })();
  </script>

  <div id="root"></div>

  <!-- 加载自动调试客户端 -->
  <script src="/common/auto-debug-client.js"></script>

  <!-- 加载 bootstrap JS（会自动挂载到 window.DevTemplateBootstrap） -->
  <script type="module" src="/assets/dev-template-bootstrap.js"></script>

  <script type="module">
    // 等待 bootstrap 加载完成
    function waitForBootstrap() {
      if (window.DevTemplateBootstrap) {
        const { renderComponent, React, ReactDOM } = window.DevTemplateBootstrap;

        // 将 React 和 ReactDOM 挂载到全局，让组件使用同一个实例
        window.React = React;
        window.ReactDOM = ReactDOM;

        console.log('[Dev Template] Bootstrap 已就绪，React 已挂载到全局');

        // 动态导入组件（此时组件会使用 window.React）
        import('{{ENTRY}}').then(module => {
          const Component = module.Component || module.default;

          // 导出到全局（供调试使用）
          window.AxhubDevComponent = Component;

          console.log('[Dev Template] Component 已加载:', Component);
          console.log('[Dev Template] 开始渲染');

          // 渲染组件
          renderComponent(Component);
        }).catch(err => {
          console.error('[Dev Template] 组件加载失败:', err);
        });
      } else {
        setTimeout(waitForBootstrap, 10);
      }
    }

    waitForBootstrap();
  </script>

</body>

</html>